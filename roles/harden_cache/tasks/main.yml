# --- Cache, DNF & logging role summary (banner) ------------------------------
- name: Build cache/DNF/logging role summary banner
  ansible.builtin.set_fact:
    cache_banner_msg:
      - "Cache, DNF & logging hardening:"
      - "DNF (RHEL/OL with dnf):"
      - "  • Ensure /etc/dnf/dnf.conf exists with safe perms."
      - "  • Configure: installonly_limit=2, clean_requirements_on_remove=True."
      - "  • Configure: keepcache=False (no stale RPMs), best=True, http_caching=none."
      - "Coredumps:"
      - "  • Write {{ coredump_conf_file | default('/etc/systemd/coredump.conf') }} from coredump_params."
      - "  • Typical policy: disable or tightly limit core dumps to protect data & disk."
      - "Journald (log retention & safety):"
      - "  • Drop-in: {{ journald_dropin_file | default('/etc/systemd/journald.conf.d/99-logging-limits.conf') }}."
      - "  • Enforce rate limiting, size caps, SystemKeepFree/RuntimeKeepFree."
      - "  • MaxRetentionSec={{ journald_params.MaxRetentionSec | default('14day') }} (or as configured)."
      - "Tmpfiles / cache pruning:"
      - "  • Ensure systemd-tmpfiles daily clean timer exists & is enabled."
      - "  • Install {{ tmpfiles_policy_path | default('/etc/tmpfiles.d/cache-prune.conf') }} for age-based cleanup:"
      - "      - /var/cache (dnf/apt/man), /tmp, /var/tmp with defined retention."
      - "  • Optional one-shot clean on first run (tmpfiles_clean_on_first_run={{ tmpfiles_clean_on_first_run | default(true) }})."
      - "Safety/behavior:"
      - "  • Idempotent: only changes configs, no surprise kernel removals."
      - "  • Disk protection: prevents cache/log growth from starving free space."

- name: Show cache/DNF/logging role summary
  ansible.builtin.debug:
    var: cache_banner_msg

- name: Ensure dnf.conf exists with correct perms (before ini_file)
  when: ansible_facts.os_family == 'RedHat' and ansible_facts.pkg_mgr == 'dnf'
  become: true
  ansible.builtin.file:
    path: /etc/dnf/dnf.conf
    state: touch
    owner: root
    group: root
    mode: '0644'

- name: Ensure /etc/dnf/dnf.conf has required settings
  when: ansible_facts.os_family == 'RedHat' and ansible_facts.pkg_mgr == 'dnf'
  become: true
  ansible.builtin.ini_file:
    path: /etc/dnf/dnf.conf
    section: main
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    no_extra_spaces: true
    create: true
    backup: true
  loop:
    - { option: installonly_limit, value: "2" }      # keep 2 kernels
    - { option: clean_requirements_on_remove, value: "True" }   # remove leaf deps
    - { option: keepcache, value: "False" }  # no cached RPMs
    - { option: best, value: "True" }   # strict newest
    - { option: http_caching, value: "none" }   # disable HTTP cache
  notify: dnf clean


- name: Write coredump policy
  copy:
    dest: "{{ coredump_conf_file }}"
    mode: "0644"
    content: |
      # Managed by Ansible
      [Coredump]
      {% for kv in coredump_params | dict2items -%}
      {{ kv.key }}={{ kv.value }}
      {% endfor -%}
  notify:
    - reload systemd daemon
    - restart systemd-coredump



# ---- journald: logging limits via drop-in ----
- name: Ensure journald drop-in directory exists
  become: true
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure journald drop-in directory exists
  file:
    path: "{{ journald_dropin_file | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install journald override with desired limits
  copy:
    dest: "{{ journald_dropin_file }}"
    owner: root
    group: root
    mode: "0644"
    content: |
      # Managed by Ansible
      [Journal]
      {% for kv in journald_params | dict2items -%}
      {{ kv.key }}={{ kv.value }}
      {% endfor -%}
  notify: restart systemd-journald



# ---- systemd-tmpfiles daily cleanup: ensure timer/service exist (copy if missing) ----
- name: Check if tmpfiles clean unit files already exist
  become: true
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - /usr/lib/systemd/system/systemd-tmpfiles-clean.timer
    - /usr/lib/systemd/system/systemd-tmpfiles-clean.service
  register: tmpfiles_units
  changed_when: false

- name: Install systemd-tmpfiles-clean.timer if missing
  when: not tmpfiles_units.results[0].stat.exists
  become: true
  ansible.builtin.copy:
    src: systemd-tmpfiles-clean.timer
    dest: /usr/lib/systemd/system/systemd-tmpfiles-clean.timer
    owner: root
    group: root
    mode: '0644'
    force: no
  notify: reload systemd daemon

- name: Install systemd-tmpfiles-clean.service if missing
  when: not tmpfiles_units.results[1].stat.exists
  become: true
  ansible.builtin.copy:
    src: systemd-tmpfiles-clean.service
    dest: /usr/lib/systemd/system/systemd-tmpfiles-clean.service
    owner: root
    group: root
    mode: '0644'
    force: no
  notify: reload systemd daemon

- name: Enable and start tmpfiles daily clean timer
  become: true
  ansible.builtin.systemd:
    name: systemd-tmpfiles-clean.timer
    enabled: true
    state: started


- name: tmpfiles cache pruning (OL 9.6 & Ubuntu)
  tags: tmpfiles_prune
  become: true
  block:

    - name: Ensure tmpfiles.d directory exists
      ansible.builtin.file:
        path: /etc/tmpfiles.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install tmpfiles policy for cache pruning (cross-distro)
      ansible.builtin.copy:
        dest: "{{ tmpfiles_policy_path }}"
        mode: "0644"
        content: |
          # Managed by Ansible — age-based cache cleanup
          d /var/cache 0755 root root -
          {% if ansible_facts.os_family == 'RedHat' %}
          q /var/cache/dnf           - - - {{ dnf_cache_retention }}    # purge old dnf cache
          {% elif ansible_facts.os_family == 'Debian' %}
          q /var/cache/apt/archives  - - - {{ dnf_cache_retention }}    # purge old apt .deb cache
          q /var/lib/apt/lists       - - - {{ man_cache_retention }}    # apt package lists
          {% endif %}
          q /var/cache/man           - - - {{ man_cache_retention }}    # man-db cache
          q /var/tmp                 - - - {{ var_tmp_retention }}
          q /tmp                     - - - {{ tmp_retention }}
      notify: reload systemd daemon

# Enable the daily tmpfiles clean timer if the unit exists
- name: Check for tmpfiles clean timer (RedHat path)
  ansible.builtin.stat:
  path: /usr/lib/systemd/system/systemd-tmpfiles-clean.timer
  register: rh_tmpfiles_timer
  changed_when: false

- name: Check for tmpfiles clean timer (Debian path)
  ansible.builtin.stat:
    path: /lib/systemd/system/systemd-tmpfiles-clean.timer
  register: deb_tmpfiles_timer
  changed_when: false

- name: Enable & start tmpfiles daily clean timer (if available)
  ansible.builtin.systemd:
    name: systemd-tmpfiles-clean.timer
    enabled: true
    state: started
  when: rh_tmpfiles_timer.stat.exists or deb_tmpfiles_timer.stat.exists

# One-shot clean only on first run (idempotent)
- name: Check if one-shot tmpfiles clean already ran
  ansible.builtin.stat:
    path: /var/lib/os_settings/.tmpfiles_cleaned_once
  register: tmpfiles_clean_ran
  changed_when: false

- name: Trigger a one-shot tmpfiles clean on first run
  ansible.builtin.command: systemd-tmpfiles --clean
  when: tmpfiles_clean_on_first_run and not tmpfiles_clean_ran.stat.exists
  changed_when: false

- name: Mark one-shot tmpfiles clean as done
  ansible.builtin.file:
    path: /var/lib/os_settings/.tmpfiles_cleaned_once
    state: touch
    mode: "0644"
  when: tmpfiles_clean_on_first_run and not tmpfiles_clean_ran.stat.exists


#- name: Weekly kernel prune (OL8/9)
#  when: ansible_facts.distribution_major_version | int >= 8
#  become: true
#  ansible.builtin.cron:
#    name: "prune old kernels"
#    user: root
#    special_time: weekly
#    job: "dnf -y remove --oldinstallonly || true"
